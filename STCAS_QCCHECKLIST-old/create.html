<?php
session_start(); 
if (isset($_SESSION['station_id'])) {
    // Station data available in session variables.
    $stationID = $_SESSION['station_id'];
    $stationName = $_SESSION['station_name'];
    $zone = $_SESSION['zone'];
    $division = $_SESSION['division'];
    $initialDate = $_SESSION['initial_date'];
    $updateDate = $_SESSION['update_date'];
} else {
    echo "No Station data available.";
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic QA Form</title>
  <link rel="stylesheet" type="text/css" href="style.css">
   <!-- 3rdâ€‘party libraries (all local) -->
  <script src="libs/jquery-3.6.0.min.js"></script>
  <script src="libs/zxing-browser.min.js"></script>
  <script src="libs/jspdf.umd.min.js"></script>
  <script src="libs/jspdf.plugin.autotable.min.js"></script>

  <!-- your application logic -->
  <script src="script.js" defer></script>
  <style>
    footer {
      position: fixed;
      bottom: 5px;
      right: 20px;
      z-index: 1000;
    }
    footer .action-buttons button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease;
    }
    footer .action-buttons button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

  <!-- Logo and Logout -->
  <div class="logo-container">
    <img src="hbl_logo.jpg" alt="Logo" class="logo">
  </div>
  <div class="acto-buttons">
    <i class="fas fa-sign-out-alt"></i> Logout
    <button class="logout-button" type="button" onclick="logout()">Logout</button>
  </div>

  <div class="sidebar">
    <button class="button" onclick="showSection('0.0')" id="station-info-button">Station Info</button>
    <button class="button" onclick="showSection('2.0')" id="button-2" disabled>1.0 Verify Serial Numbers Of Equipment as per IC</button>
    <button class="button" onclick="showSection('3.0')" id="button-3" disabled>2.0 Tower and RTU</button>
    <button class="button" onclick="showSection('4.0')" id="button-4" disabled>3.0 Station TCAS</button>
    <button class="button" onclick="showSection('5.0')" id="button-5" disabled>4.0 Relay installation and wiring</button>
    <button class="button" onclick="showSection('6.0')" id="button-6" disabled>5.0 SMOCIP</button>
    <button class="button" onclick="showSection('7.0')" id="button-7" disabled>6.0 RFID tags</button>
    <button class="button" onclick="showSection('8.0')" id="button-8" disabled>7.0 General and safety</button>
  </div>

  
  <script>
    window.addEventListener('load', function() {
      // Clear all relevant stored data to ensure a fresh page each time.
      sessionStorage.removeItem("stationDetails");
      sessionStorage.removeItem("observationsData");
      // Optionally, clear all of sessionStorage (caution: if you have other data you want to keep)
      // sessionStorage.clear();
      // Also clear localStorage if you use it:
      // localStorage.removeItem("selectedStationId");
      // localStorage.removeItem("stationDetails");
      
      // Read the URL hash to determine which section to show (e.g., "#0.0")
      const hash = window.location.hash;
      if (hash) {
        const sectionId = hash.substring(1);  // removes the '#' character
        if (typeof showSection === 'function') {
          showSection(sectionId);
        } else {
          console.log("showSection function is not defined. Default section:", sectionId);
        }
      }
    });
  </script>
  

  <!-- Your additional scripts (for handling station info fetching, etc.) -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const urlParams = new URLSearchParams(window.location.search);
      // If you don't want to prefill based on a query parameter, skip this part
      const stationId = urlParams.get("station_id");
      if (stationId) {
        // Optionally remove these lines if you always want a fresh form
        localStorage.setItem("selectedStationId", stationId);
        // Fetch and fill details if desired. Otherwise, don't populate:
        // fetch(`getReportById.php?station_id=${stationId}`)
        //   .then(response => response.json())
        //   .then(data => { /* populate form fields if needed */ })
        //   .catch(error => console.error("Fetch error:", error));
      } else {
        // No query parameter - ensure stored data is not used.
        localStorage.removeItem("stationDetails");
      }
    });
</script>
<script>
 window.addEventListener('load', function() {
  // Clear only the keys specific to the form data.
  sessionStorage.removeItem("stationDetails");
  sessionStorage.removeItem("observationsData");
  
  localStorage.removeItem("selectedStationId");
  localStorage.removeItem("stationDetails");
  // Do not remove "user_id" so that the user id remains stored.

  // Clear form fields explicitly
  const fieldIds = ["station-id", "station-name", "zone", "division", "initial-date", "updated-date"];
  fieldIds.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.value = "";
    }
  });

  // Check the URL hash to show the default section if present.
  const hash = window.location.hash; // e.g., "#0.0"
  if (hash) {
    const sectionId = hash.substring(1);  // removes the '#' character
    if (typeof showSection === 'function') {
      showSection(sectionId);
    } else {
      console.log("showSection function is not defined. Default section:", sectionId);
    }
  }
});

</script>

  

  
  
  <!-- Success Modal -->
  <div id="success-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background-color: #4CAF50; color: white; border-radius: 5px;">
    Data saved successfully!
  </div>
  <!-- Main Content Section -->
  <div class="main-content">
    <div id="main-content">
      <div id="dynamic-content">
        <p>Select a section from the left to view details.</p>
      </div>
    </div>
  </div>

  <!-- Add Image Section (optional, not modified here) -->
  <div id="add-image-section" style="display: none;">
    <!-- Code for image capture / upload -->
    <!-- ... -->
  </div>
  
  <!-- Footer with Generate Report button -->
 <footer>
  <div class="action-buttons">
    <button type="button" onclick="confirmGenerateReport()">Generate Report</button>
  </div>
</footer>


  <script>

function confirmGenerateReport() {
  const userConfirmed = confirm("Do you want to generate the report?");
  if (userConfirmed) {
    generateReport(); // Call your actual function
  }
}

 function beforeUnloadHandler(event) {
  event.returnValue = "Please generate report before closing.";
  return event.returnValue;
}
window.addEventListener("beforeunload", beforeUnloadHandler);



  </script>
  
  <!-- Additional scripts (for station info handling, etc.) -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const urlParams = new URLSearchParams(window.location.search);
      const stationId = urlParams.get("station_id");
      if (stationId) {
        localStorage.setItem("selectedStationId", stationId);
        // Set current date if necessary.
        const initialDateElem = document.getElementById("initial-date");
        if (initialDateElem) {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, "0");
          const day = String(now.getDate()).padStart(2, "0");
          initialDateElem.value = `${year}-${month}-${day}`;
        }
        const updateDateElem = document.getElementById("updated-date");
        if (updateDateElem) {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, "0");
          const day = String(now.getDate()).padStart(2, "0");
          updateDateElem.value = `${year}-${month}-${day}`;
        }
        fetch(`getReportById.php?station_id=${stationId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const stationInfo = data.data.stationDetails;
              if (stationInfo) {
                localStorage.setItem("stationDetails", JSON.stringify(stationInfo));
                const stationIdElem = document.getElementById("station-id");
                if (stationIdElem) stationIdElem.value = stationInfo.stationId || "";
                const stationNameElem = document.getElementById("station-name");
                if (stationNameElem) stationNameElem.value = stationInfo.stationName || "";
                const zoneElem = document.getElementById("zone");
                if (zoneElem) zoneElem.value = stationInfo.zone || "";
                const divisionElem = document.getElementById("division");
                if (divisionElem) divisionElem.value = stationInfo.division || "";
                const initialDateElem=document.getElementById("initial-date");
                if (initialDateElem) initialDateElem.value=stationInfo.initialDate || "";
                const updateDateElem=document.getElementById("updated-date");
                if (updateDateElem) updateDateElem.value=stationInfo.updatedDate || "";
              }
            } else {
              console.error("Error fetching report details:", data.message);
            }
          })
          .catch(error => console.error("Fetch error:", error));
      } else {
        localStorage.removeItem("stationDetails");
        const stored = localStorage.getItem("stationDetails");
        if (stored) {
          const stationInfo = JSON.parse(stored);
          const stationIdElem = document.getElementById("station-id");
          if (stationIdElem) stationIdElem.value = stationInfo.stationID || "";
          const stationNameElem = document.getElementById("station-name");
          if (stationNameElem) stationNameElem.value = stationInfo.stationName || "";
          const zoneElem = document.getElementById("zone");
          if (zoneElem) zoneElem.value = stationInfo.zone || "";
          const divisionElem = document.getElementById("division");
          if (divisionElem) divisionElem.value = stationInfo.division || "";
          const initialDateElem = document.getElementById("initial-date");
          if (initialDateElem && stationInfo.initialDate) {
            const d = new Date(stationInfo.initialDate);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            initialDateElem.value = `${year}-${month}-${day}`;
          }
          const updateDateElem = document.getElementById("updated-date");
          if (updateDateElem && stationInfo.updatedDate) {
            const d = new Date(stationInfo.updatedDate);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            updateDateElem.value = `${year}-${month}-${day}`;
          }
        }
      }
    });
  </script>

<div id="messageBox" style="color: green; font-weight: bold; margin-top: 10px;"></div>

</body>
</html>
